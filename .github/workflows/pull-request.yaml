name: Pull Request

on:
  pull_request:
    branches: ["*"]

jobs:
  code-scan:
    name: Code Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner in repo mode
        uses: aquasecurity/trivy-action@0.30.0
        with:
          scan-type: "fs"
          ignore-unfixed: true
          output: trivy.txt
          severity: "CRITICAL"

      - name: Format Trivy Scan Result
        run: |
          if [ -s trivy.txt ]; then
            echo -e "## Vulnerability Scan Results\n<details><summary>Details</summary>\n\n\`\`\`\n$(cat trivy.txt)\n\`\`\`\n</details>" > formatted-trivy-result.md
          else
            echo -e "## Vulnerability Scan Results\nNo vulnerabilities were detected." > formatted-trivy-result.md
          fi

      - name: Comment PR with Trivy scan results
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          recreate: true
          path: formatted-trivy-result.md

      - name: Clean up Trivy result file
        run: rm -f trivy.txt formatted-trivy-result.md
